import{API_BASE_URL as i}from"./config-22307f7a.js";class h{constructor(){this.userId=this.getUserId()}getUserId(){const t=JSON.parse(localStorage.getItem("userInfo")||"{}");return t.username||t.userId||t.email||"anonymous"}getAuthHeaders(){const t=localStorage.getItem("authToken"),e={"Content-Type":"application/json"};return t&&(e.Authorization=`Bearer ${t}`),e}async saveConversation(t){try{const e={...t,userId:t.userId||this.getUserId()},o=await fetch(`${i}/conversations`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify(e)});if(!o.ok)throw new Error(`Failed to save conversation: ${o.statusText}`);return await o.json()}catch(e){throw console.error("ëŒ€í™” ì €ìž¥ ì‹¤íŒ¨:",e),this.saveToLocalStorage(t),e}}async listConversations(t=null){try{const e=this.getUserId(),o=new URLSearchParams({userId:e});t&&o.append("engineType",t);const r=await fetch(`${i}/conversations?${o}`,{method:"GET",headers:this.getAuthHeaders()});if(!r.ok)throw new Error(`Failed to list conversations: ${r.statusText}`);return(await r.json()).conversations||[]}catch(e){return console.error("ëŒ€í™” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:",e),this.getFromLocalStorage(t)}}async getConversation(t){try{const e=await fetch(`${i}/conversations/${t}`,{method:"GET",headers:this.getAuthHeaders()});if(!e.ok)throw new Error(`Failed to get conversation: ${e.statusText}`);return await e.json()}catch(e){return console.error("ëŒ€í™” ì¡°íšŒ ì‹¤íŒ¨:",e),this.getConversationFromLocalStorage(t)}}async updateConversationTitle(t,e){try{const o=await fetch(`${i}/conversations/${t}`,{method:"PATCH",headers:{...this.getAuthHeaders(),"Content-Type":"application/json"},body:JSON.stringify({title:e})});if(!o.ok)throw new Error(`Failed to update title: ${o.statusText}`);const r=await o.json();return console.log("âœï¸ ì œëª© ìˆ˜ì • API ì‘ë‹µ:",r),this.updateLocalStorageTitle(t,e),r}catch(o){throw console.error("ì œëª© ìˆ˜ì • ì‹¤íŒ¨:",o),this.updateLocalStorageTitle(t,e),o}}updateLocalStorageTitle(t,e){try{const o=JSON.parse(localStorage.getItem("conversations")||"{}"),r=Object.keys(o).find(s=>o[s].conversationId===t);if(r&&o[r])o[r].title=e,o[r].updatedAt=new Date().toISOString(),localStorage.setItem("conversations",JSON.stringify(o)),console.log("âœï¸ localStorage ì œëª© ì—…ë°ì´íŠ¸ ì„±ê³µ");else{const s=this.getUserId(),n=`conversation_${t}`;o[n]={conversationId:t,userId:s,title:e,messages:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},localStorage.setItem("conversations",JSON.stringify(o)),console.log("âœï¸ localStorageì— ìƒˆ ëŒ€í™” ìƒì„± ë° ì œëª© ì„¤ì •")}}catch(o){console.error("localStorage ì œëª© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",o)}}async deleteConversation(t){try{const e=new URLSearchParams({userId:this.userId});(await fetch(`${i}/conversations/${t}?${e}`,{method:"DELETE",headers:this.getAuthHeaders()})).ok||console.warn("ì„œë²„ì—ì„œ ì‚­ì œ ì‹¤íŒ¨, localStorageì—ì„œë§Œ ì‚­ì œ ì‹œë„"),this.deleteFromLocalStorage(t);const r=JSON.parse(localStorage.getItem("conversations")||"{}"),s=Object.values(r).find(n=>n.conversationId===t);if(s&&s.engineType){const n=`chat_history_${s.engineType}`,l=localStorage.getItem(n);if(l){const d=JSON.parse(l).filter(g=>!g.conversationId||g.conversationId!==t);d.length===0?localStorage.removeItem(n):localStorage.setItem(n,JSON.stringify(d))}}return!0}catch(e){return console.error("ëŒ€í™” ì‚­ì œ ì¤‘ ì˜¤ë¥˜:",e),this.deleteFromLocalStorage(t),!0}}autoSave(t){this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.saveToLocalStorage(t)},3e3)}saveToLocalStorage(t){try{const e=JSON.parse(localStorage.getItem("conversations")||"{}"),o=t.conversationId||crypto.randomUUID(),r=`conversation_${t.engineType}_${o}`,s=Object.keys(e).find(n=>e[n].conversationId===o);s?e[s]={...e[s],...t,userId:this.userId,updatedAt:new Date().toISOString()}:e[r]={...t,conversationId:o,userId:this.userId,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},localStorage.setItem("conversations",JSON.stringify(e))}catch(e){console.error("localStorage ì €ìž¥ ì‹¤íŒ¨:",e)}}getFromLocalStorage(t=null){try{const e=JSON.parse(localStorage.getItem("conversations")||"{}");let o=Object.values(e);return o=o.filter(r=>r.userId===this.userId),t&&(o=o.filter(r=>r.engineType===t)),o.sort((r,s)=>new Date(s.updatedAt)-new Date(r.updatedAt)),o}catch(e){return console.error("localStorage ì¡°íšŒ ì‹¤íŒ¨:",e),[]}}getConversationFromLocalStorage(t){try{const e=JSON.parse(localStorage.getItem("conversations")||"{}");return Object.values(e).find(r=>r.conversationId===t&&r.userId===this.userId)||null}catch(e){return console.error("localStorage ì¡°íšŒ ì‹¤íŒ¨:",e),null}}deleteFromLocalStorage(t){try{const e=JSON.parse(localStorage.getItem("conversations")||"{}"),o=Object.keys(e).find(r=>e[r].conversationId===t&&e[r].userId===this.userId);o&&(delete e[o],localStorage.setItem("conversations",JSON.stringify(e)))}catch(e){console.error("localStorage ì‚­ì œ ì‹¤íŒ¨:",e)}}async syncConversations(){try{const t=this.getFromLocalStorage();console.log(`ðŸ”„ ${t.length}ê°œ ëŒ€í™” ë™ê¸°í™” ì‹œìž‘`);for(const e of t)try{await this.saveConversation(e)}catch(o){console.error("ëŒ€í™” ë™ê¸°í™” ì‹¤íŒ¨:",e.conversationId,o)}console.log("âœ… ëŒ€í™” ë™ê¸°í™” ì™„ë£Œ")}catch(t){console.error("ëŒ€í™” ë™ê¸°í™” ì‹¤íŒ¨:",t)}}}const c=new h,S=a=>c.saveConversation(a),I=a=>c.listConversations(a),y=a=>c.getConversation(a),m=a=>c.deleteConversation(a),f=(a,t)=>c.updateConversationTitle(a,t),p=a=>c.autoSave(a),w=()=>c.syncConversations();export{p as autoSaveConversation,c as default,m as deleteConversation,y as getConversation,I as listConversations,S as saveConversation,w as syncConversations,f as updateConversationTitle};
//# sourceMappingURL=conversationService-3054f49b.js.map
