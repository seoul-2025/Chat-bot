#!/usr/bin/env python3\nimport json\nimport boto3\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\nimport threading\nimport logging\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n# AWS Bedrock 클라이언트\nbedrock = boto3.client('bedrock-runtime', region_name='us-east-1')\n\nclass ChatHandler(BaseHTTPRequestHandler):\n    def do_POST(self):\n        if self.path == '/chat':\n            try:\n                content_length = int(self.headers['Content-Length'])\n                post_data = self.rfile.read(content_length)\n                data = json.loads(post_data.decode('utf-8'))\n                \n                user_message = data.get('message', '')\n                logger.info(f\"Processing: {user_message[:50]}...\")\n                \n                # Bedrock 호출\n                response = bedrock.invoke_model(\n                    modelId='anthropic.claude-3-5-sonnet-20241022-v2:0',\n                    body=json.dumps({\n                        \"anthropic_version\": \"bedrock-2023-05-31\",\n                        \"max_tokens\": 4000,\n                        \"messages\": [{\"role\": \"user\", \"content\": user_message}]\n                    })\n                )\n                \n                response_body = json.loads(response['body'].read())\n                ai_response = response_body['content'][0]['text']\n                \n                # 응답 전송\n                self.send_response(200)\n                self.send_header('Content-type', 'application/json')\n                self.send_header('Access-Control-Allow-Origin', '*')\n                self.end_headers()\n                \n                response_data = {\n                    \"type\": \"ai_response\",\n                    \"message\": ai_response\n                }\n                \n                self.wfile.write(json.dumps(response_data).encode('utf-8'))\n                \n            except Exception as e:\n                logger.error(f\"Error: {e}\")\n                self.send_response(500)\n                self.send_header('Content-type', 'application/json')\n                self.send_header('Access-Control-Allow-Origin', '*')\n                self.end_headers()\n                \n                error_response = {\n                    \"type\": \"error\",\n                    \"message\": str(e)\n                }\n                \n                self.wfile.write(json.dumps(error_response).encode('utf-8'))\n        else:\n            self.send_response(404)\n            self.end_headers()\n    \n    def do_OPTIONS(self):\n        self.send_response(200)\n        self.send_header('Access-Control-Allow-Origin', '*')\n        self.send_header('Access-Control-Allow-Methods', 'POST, OPTIONS')\n        self.send_header('Access-Control-Allow-Headers', 'Content-Type')\n        self.end_headers()\n\ndef main():\n    server_address = ('127.0.0.1', 8769)\n    httpd = HTTPServer(server_address, ChatHandler)\n    logger.info(f\"HTTP Server running on http://127.0.0.1:8769\")\n    httpd.serve_forever()\n\nif __name__ == \"__main__\":\n    main()\n